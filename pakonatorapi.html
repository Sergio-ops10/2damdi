<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akinator Clon Din√°mico con IA</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuraci√≥n de la fuente Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Fondo gris claro */
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Contenedor Principal del Juego -->
    <div id="game-container" class="w-full max-w-lg bg-white shadow-2xl rounded-xl p-8 transition-all duration-300">
        <h1 class="text-3xl font-extrabold text-center mb-6 text-indigo-700">üîÆ El Adivinador Din√°mico üßû</h1>
        
        <!-- √Årea de visualizaci√≥n de mensajes/preguntas -->
        <div id="message-area" class="text-center mb-8 min-h-[120px] flex flex-col justify-center bg-indigo-50 p-4 rounded-lg border-2 border-indigo-200">
            <p id="question-text" class="text-xl font-semibold text-gray-800 transition-opacity duration-300">
                ¬°Piensa en un personaje, objeto o animal!
            </p>
            <p id="sub-text" class="text-sm text-gray-500 mt-2 italic">
                Cuando est√©s listo, haz clic en Empezar.
            </p>
            <!-- Contenedor para fuentes (citas) -->
            <div id="sources-container" class="text-xs text-gray-600 mt-3 text-left hidden">
                <p class="font-bold mb-1">Fuentes de conocimiento (Google Search):</p>
                <ul id="source-list" class="space-y-1"></ul>
            </div>
        </div>

        <!-- √Årea de Botones -->
        <div id="button-area" class="flex flex-col space-y-4">
            <!-- Botones de Respuesta (Inicialmente ocultos) -->
            <div id="answer-buttons" class="hidden grid grid-cols-2 gap-4">
                <button id="btn-yes" class="py-3 px-6 bg-green-500 hover:bg-green-600 text-white font-bold rounded-full shadow-md transition-transform transform hover:scale-105 active:scale-95">
                    S√≠
                </button>
                <button id="btn-no" class="py-3 px-6 bg-red-500 hover:bg-red-600 text-white font-bold rounded-full shadow-md transition-transform transform hover:scale-105 active:scale-95">
                    No
                </button>
                <button id="btn-maybe" class="col-span-2 py-3 px-6 bg-yellow-500 hover:bg-yellow-600 text-white font-bold rounded-full shadow-md transition-transform transform hover:scale-105 active:scale-95">
                    No s√© / Parcialmente
                </button>
            </div>

            <!-- Input para el personaje (Oculto al inicio) -->
            <div id="input-area" class="hidden flex flex-col space-y-2">
                <input type="text" id="character-input" placeholder="Escribe el nombre del personaje (ej: Taylor Swift)"
                        class="p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                <button id="btn-reveal" class="py-3 px-6 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-full shadow-lg transition-transform transform hover:scale-105 active:scale-95">
                    ¬°Revelar y Aprender!
                </button>
            </div>
            
            <!-- Bot√≥n de Inicio/Reinicio -->
            <button id="btn-start" class="py-3 px-6 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-full shadow-lg transition-transform transform hover:scale-105 active:scale-95">
                Empezar a Jugar
            </button>
            
            <!-- Bot√≥n de Reinicio (Oculto durante el juego inicial) -->
            <button id="btn-restart-hidden" class="hidden py-3 px-6 bg-gray-500 hover:bg-gray-600 text-white font-bold rounded-full shadow-lg transition-transform transform hover:scale-105 active:scale-95">
                Volver a Jugar
            </button>

            <!-- Mensaje de estado de la b√∫squeda API (para visualizaci√≥n) -->
            <p id="api-status" class="text-xs text-blue-500 text-center mt-2 italic hidden">
                Consultando la base de datos global...
            </p>
            
            <!-- Mensaje de estado de Firebase (para cumplimiento) -->
            <p id="auth-status" class="text-xs text-gray-400 text-center mt-4">
                Autenticaci√≥n: Inicializando...
            </p>
        </div>

    </div>

    <!-- Scripts de Firebase -->
    <script type="module">
        // Firebase imports (required for the Canvas environment)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global Firebase variables (Required by the environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-akinator-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app = null;
        let db = null;
        let auth = null;
        let userId = 'anonimo';
        
        // Firebase initialization and Authentication
        if (firebaseConfig) {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                const authStatusElement = document.getElementById('auth-status');
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatusElement.textContent = `Autenticaci√≥n: OK (ID: ${userId})`;
                        // Once authenticated, initialize the game
                        window.initializeGame(); 
                    } else {
                        // Attempt to authenticate with the token or anonymously
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            authStatusElement.textContent = 'Autenticaci√≥n: Fallida.';
                            console.error("Authentication error:", error);
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                document.getElementById('auth-status').textContent = 'Error: No se pudo inicializar Firebase.';
            }
        } else {
            document.getElementById('auth-status').textContent = 'Modo Offline (Sin persistencia de datos).';
            // If no config, still initialize the game
            window.initializeGame();
        }
    </script>

    <!-- Game Logic in JavaScript -->
    <script type="module">
        // El √°rbol de decisi√≥n est√°tico ha sido ELIMINADO.
        // Ahora el juego se basa completamente en la generaci√≥n din√°mica de preguntas por la IA.
        
        // Estado del juego
        let gameHistory = []; // { type: 'Q'/'A', text: '...' }
        let currentQuestion = ""; // Almacena la √∫ltima pregunta formulada por el Adivinador

        // DOM element references
        const questionText = document.getElementById('question-text');
        const subText = document.getElementById('sub-text');
        const btnStart = document.getElementById('btn-start');
        const btnRestartHidden = document.getElementById('btn-restart-hidden');
        const answerButtons = document.getElementById('answer-buttons');
        const btnYes = document.getElementById('btn-yes');
        const btnNo = document.getElementById('btn-no');
        const btnMaybe = document.getElementById('btn-maybe');
        const apiStatus = document.getElementById('api-status');
        const inputArea = document.getElementById('input-area');
        const characterInput = document.getElementById('character-input');
        const btnReveal = document.getElementById('btn-reveal');
        const sourcesContainer = document.getElementById('sources-container');
        const sourceList = document.getElementById('source-list');

        // Configuraci√≥n de la API de Gemini
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        const API_KEY = ""; // El entorno Canvas proporciona esta clave

        /**
         * Funci√≥n para realizar una llamada fetch con reintentos (backoff exponencial).
         * @param {string} url - La URL del endpoint.
         * @param {Object} options - Opciones de fetch (m√©todo, headers, body, etc.).
         * @param {number} retries - N√∫mero de reintentos restantes.
         */
        const fetchWithRetry = async (url, options, retries = 3) => {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    if (response.status === 429) { // Demasiadas peticiones
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000 + Math.random() * 1000));
                        continue;
                    }
                    throw new Error(`Error HTTP: ${response.status}`);
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000 + Math.random() * 1000));
                }
            }
            throw new Error("Fallo la llamada a la API despu√©s de m√∫ltiples reintentos.");
        };
        
        /**
         * Extrae las fuentes de un candidato de respuesta de la API de Gemini.
         */
        const extractSources = (candidate) => {
            let sources = [];
            const groundingMetadata = candidate.groundingMetadata;
            if (groundingMetadata && groundingMetadata.groundingAttributions) {
                sources = groundingMetadata.groundingAttributions
                    .map(attribution => ({
                        uri: attribution.web?.uri,
                        title: attribution.web?.title,
                    }))
                    .filter(source => source.uri && source.title); // Filtrar fuentes v√°lidas
            }
            return sources;
        };

        /**
         * Llama a la API de Gemini con la historia del juego para obtener la siguiente pregunta o adivinanza.
         */
        const fetchNextQuestionOrGuess = async () => {
            apiStatus.textContent = `Analizando tus ${gameHistory.length} respuestas para la siguiente pregunta o adivinanza...`;
            apiStatus.classList.remove('hidden');
            sourcesContainer.classList.add('hidden');
            
            answerButtons.classList.add('hidden'); // Hide buttons while thinking

            const conversationHistory = gameHistory.map(item => `${item.type}: ${item.text}`).join('\n');
            
            // System prompt para guiar a la IA y forzar el formato de salida
            const systemPrompt = "Eres un Akinator profesional que adivina personajes, objetos o animales. Tu objetivo es acotar el personaje. Analiza la conversaci√≥n. Si tienes alta confianza, haz tu adivinanza. Si NO est√°s seguro, formula la pr√≥xima pregunta de S√ç/NO m√°s l√≥gica. Usa el formato 'GUESS: [Nombre del Personaje]' para adivinar y 'Q: [Tu pregunta de S√ç/NO]?' para preguntar. NUNCA a√±adas texto extra antes o despu√©s de 'GUESS:' o 'Q:'. La pregunta debe estar en espa√±ol.";

            const userQuery = `La conversaci√≥n hasta ahora es:\n${conversationHistory}\n\n¬øCu√°l es el siguiente paso (pregunta o adivinanza)?`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetchWithRetry(`${GEMINI_API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text.trim();
                    const sources = extractSources(candidate);

                    if (text.startsWith("GUESS:")) {
                        const guess = text.substring(6).trim();
                        displayGuess(guess, sources);
                    } else if (text.startsWith("Q:")) {
                        const question = text.substring(2).trim();
                        currentQuestion = question; // Store the new question
                        gameHistory.push({ type: 'Q', text: question });
                        displayQuestion(question, sources);
                    } else {
                        // Fallback for unexpected format or if the model can't figure it out
                        displayError("El Adivinador no pudo formular una pregunta v√°lida. Reiniciando.", sources);
                        setTimeout(restartGame, 3000);
                    }
                } else {
                    displayError("El Adivinador se ha quedado sin ideas. ¬°Has ganado!", []);
                }

            } catch (error) {
                console.error("Error calling Gemini API for next step:", error);
                displayError("Error de conexi√≥n con la API de generaci√≥n de conocimiento.", []);
            } finally {
                apiStatus.classList.add('hidden');
            }
        };


        // --- Game Flow Functions ---

        /**
         * Muestra las fuentes (citas) de la API de Gemini.
         * @param {Array<Object>} sources - Lista de objetos de fuente.
         */
        const displaySources = (sources) => {
            sourceList.innerHTML = '';
            if (sources.length > 0) {
                sources.slice(0, 3).forEach((source, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex items-start';
                    li.innerHTML = `
                        <span class="mr-1 text-indigo-500">${index + 1}.</span>
                        <a href="${source.uri}" target="_blank" class="hover:text-indigo-700 hover:underline break-words">${source.title}</a>
                    `;
                    sourceList.appendChild(li);
                });
                sourcesContainer.classList.remove('hidden');
            } else {
                sourcesContainer.classList.add('hidden');
            }
        };
        
        const displayError = (message, sources) => {
            questionText.textContent = message;
            subText.textContent = "Algo sali√≥ mal. Por favor, reinicia el juego.";
            answerButtons.classList.add('hidden');
            btnStart.classList.add('hidden');
            btnRestartHidden.classList.remove('hidden');
            inputArea.classList.add('hidden');
            displaySources(sources);
        };


        // Handles the failure state: asks for the character's name and fetches attributes
        const handleAkinatorFailure = () => {
            questionText.textContent = "¬°Me has superado! No pude adivinarlo. üòî";
            subText.textContent = "Para aprender m√°s, por favor, revela el personaje en el cuadro de abajo.";
            
            answerButtons.classList.add('hidden');
            btnStart.classList.add('hidden');
            btnRestartHidden.classList.remove('hidden');
            inputArea.classList.remove('hidden');
            sourcesContainer.classList.add('hidden');
        };

        // This function remains for the "learning" part when the player wins/Akinator fails
        const fetchCharacterAttributes = async (characterName) => {
            apiStatus.textContent = `Consultando la base de datos global (Google Search) sobre ${characterName}...`;
            apiStatus.classList.remove('hidden');

            const userQuery = `Dime los 3 o 4 atributos m√°s importantes de ${characterName} para crear preguntas de un juego de adivinanzas (por ejemplo: "¬øEs cantante?", "¬øEs de Marvel?", "¬øEs hist√≥rico?"). Formatea la respuesta como una lista de preguntas.`;
            const systemPrompt = "Eres un analista de datos de personajes. Tu tarea es responder con una lista concisa de preguntas de s√≠/no basadas en los atributos clave del personaje solicitado. Lim√≠tate estrictamente a 4 preguntas concisas m√°ximo. NO incluyas ninguna explicaci√≥n extra, solo la lista de preguntas.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetchWithRetry(`${GEMINI_API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    const sources = extractSources(candidate);

                    return { text, sources };

                } else {
                    return { text: "No se pudo generar informaci√≥n relevante para este personaje. Intenta con otro.", sources: [] };
                }

            } catch (error) {
                console.error("Error calling Gemini API for attributes:", error);
                return { text: "Error de conexi√≥n con la API de generaci√≥n de conocimiento.", sources: [] };
            } finally {
                apiStatus.classList.add('hidden');
            }
        };

        const revealCharacterAndLearn = async () => {
            const characterName = characterInput.value.trim();
            if (!characterName) {
                subText.textContent = "Por favor, introduce un nombre v√°lido.";
                return;
            }

            questionText.textContent = `Analizando a "${characterName}"...`;
            subText.textContent = "Buscando atributos clave en la web...";
            
            // Fetch attributes using the API
            const { text, sources } = await fetchCharacterAttributes(characterName);
            
            // Display learning result
            questionText.textContent = `¬°Gracias! Esto es lo que El Adivinador aprendi√≥ sobre ${characterName}:`;
            subText.innerHTML = `Nuevas preguntas sugeridas para el √°rbol de conocimiento:<br><span class="font-mono text-gray-700 whitespace-pre-wrap mt-2 block">${text}</span>`;
            
            // Display sources
            displaySources(sources);
            
            // Hide input and show restart
            inputArea.classList.add('hidden');
            btnRestartHidden.textContent = 'Volver a Jugar';
            btnStart.classList.add('hidden'); // Ensure no stray start button
        };


        // Function to display a question
        const displayQuestion = (question, sources) => {
            questionText.textContent = question;
            subText.textContent = "¬øTu personaje encaja en esta descripci√≥n?";
            btnStart.classList.add('hidden');
            btnRestartHidden.classList.add('hidden');
            answerButtons.classList.remove('hidden');
            inputArea.classList.add('hidden');
            displaySources(sources); // Display sources for the new question
        };

        // Function to display the final guess and result
        const displayGuess = (guess, sources) => {
            questionText.textContent = `¬°Creo que est√°s pensando en... ${guess}!`;
            subText.textContent = "¬øHe acertado?";

            answerButtons.classList.add('hidden');
            btnRestartHidden.textContent = 'Volver a Jugar';
            
            btnStart.textContent = '¬°S√≠, has acertado!';
            btnStart.classList.remove('hidden');
            btnRestartHidden.classList.remove('hidden');
            inputArea.classList.add('hidden');
            displaySources(sources); // Display sources for the guess
        };

        // Answer handler
        const handleAnswer = (answer) => {
            if (!currentQuestion) return; // Ignore clicks if no question is active

            // 1. Record the user's answer in the history
            let answerText = "";
            if (answer === 'yes') answerText = "S√≠";
            else if (answer === 'no') answerText = "No";
            else if (answer === 'maybe') answerText = "No s√© / Parcialmente";
            
            gameHistory.push({ type: 'A', text: answerText });
            
            // 2. Clear question and status, then fetch the next step
            questionText.textContent = `Respuesta enviada: ${answerText}.`;
            subText.textContent = "El Adivinador est√° pensando...";
            answerButtons.classList.add('hidden');
            
            // Use a slight delay for visual feedback
            setTimeout(fetchNextQuestionOrGuess, 500);
        };

        // Starts the game
        const startGame = () => {
            gameHistory = []; // Clear history at start
            currentQuestion = ""; // Clear current question
            
            // Initial prompt to start the conversation and get the first question
            gameHistory.push({ type: 'Q', text: "¬°Hola! Estoy listo para adivinar. ¬øPuedes decirme si tu personaje es una persona real o de ficci√≥n para empezar?"});
            
            // Display the first static question to save an API call and set context
            currentQuestion = "¬øTu personaje es una persona real o de ficci√≥n?";
            displayQuestion(currentQuestion, []); 
        };

        // Restarts the game
        const restartGame = () => {
            gameHistory = [];
            currentQuestion = "";
            characterInput.value = '';
            questionText.textContent = "¬°Piensa en un nuevo personaje!";
            subText.textContent = "Cuando est√©s listo, haz clic en Empezar.";
            
            btnStart.textContent = 'Empezar a Jugar';
            btnStart.classList.remove('hidden');
            btnRestartHidden.classList.add('hidden');
            answerButtons.classList.add('hidden');
            inputArea.classList.add('hidden');
            sourcesContainer.classList.add('hidden');
        };

        // Event Listeners assignment
        btnStart.addEventListener('click', () => {
            if (btnStart.textContent.includes('has acertado')) {
                restartGame();
            } else {
                startGame();
            }
        });
        btnRestartHidden.addEventListener('click', restartGame);
        btnYes.addEventListener('click', () => handleAnswer('yes'));
        btnNo.addEventListener('click', () => handleAnswer('no'));
        btnMaybe.addEventListener('click', () => handleAnswer('maybe'));
        btnReveal.addEventListener('click', revealCharacterAndLearn);

        // Expose the initialization function globally
        window.initializeGame = () => {
            console.log("Juego inicializado. Listo para empezar.");
        };

    </script>
</body>
</html>